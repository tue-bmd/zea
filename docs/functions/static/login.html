<!DOCTYPE html>
<html>
  <head>
    <title>Sign in</title>
    <!-- Firebase App and Auth (compat versions for FirebaseUI) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <!-- Official FirebaseUI for simple auth UI -->
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.css" />
    <script src="https://www.gstatic.com/firebasejs/ui/6.0.2/firebase-ui-auth.js"></script>
    <style>
      body { font-family: sans-serif; background: #f8f9fa; text-align: center; padding-top: 80px; }
      .firebaseui-card { display: inline-block; box-shadow: 0 2px 8px #0002; padding: 2em; border-radius: 10px; background: #fff; }
    </style>
  </head>
  <body>
    <div class="firebaseui-card">
      <h2>Sign in to view docs</h2>
      <div id="firebaseui-auth-container"></div>
      <div id="loader">Loading...</div>
    </div>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyDjc7w0xvcgKTGM7bkXCJFUq9YBRSJTlXg",
        authDomain: "usbmd-toolbox.firebaseapp.com",
        projectId: "usbmd-toolbox",
      };
      firebase.initializeApp(firebaseConfig);

      // FirebaseUI config
      var uiConfig = {
        signInOptions: [
          firebase.auth.GithubAuthProvider.PROVIDER_ID
        ],
        signInSuccessUrl: "/", // Redirect after successful sign-in (will be intercepted below)
        callbacks: {
          signInSuccessWithAuthResult: function(authResult, redirectUrl) {
            // After sign-in, exchange ID token for session cookie
            authResult.user.getIdToken().then(function(idToken) {
              fetch("/sessionLogin", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({idToken: idToken})
              })
              .then(response => {
                if (response.ok) {
                  window.location.assign("/"); // Reload to protected docs
                } else {
                  alert("Session creation failed. Please try again.");
                }
              });
            });
            // Don't automatically redirect
            return false;
          }
        }
      };

      // Initialize the FirebaseUI Widget using Firebase.
      var ui = new firebaseui.auth.AuthUI(firebase.auth());
      ui.start("#firebaseui-auth-container", uiConfig);

      // Remove loader when ready
      firebase.auth().onAuthStateChanged(function() {
        document.getElementById('loader').style.display = 'none';
      });
    </script>
  </body>
</html>
